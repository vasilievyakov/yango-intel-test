# Yango Competitive Intelligence — Технические требования MVP

---

## 1. Модуль: Парсинг сайтов конкурентов

### 1.1 Целевые сайты

| Конкурент | URL для водителей | URL для пассажиров |
|-----------|-------------------|-------------------|
| InDriver | https://indriver.com/pe/driver | https://indriver.com/pe |
| Didi | https://web.didiglobal.com/pe/driver | https://web.didiglobal.com/pe |
| Uber | https://www.uber.com/pe/es/drive | https://www.uber.com/pe/es |
| Cabify | https://cabify.com/pe/driver | https://cabify.com/pe |

### 1.2 Извлекаемые данные

#### Страница для водителей
| Поле | Тип | Описание |
|------|-----|----------|
| commission_rate | float | Комиссия платформы (%) |
| min_fare | float | Минимальная стоимость поездки |
| signup_bonus | float | Бонус за регистрацию |
| referral_bonus | float | Бонус за приглашение |
| requirements | text[] | Требования к водителю |
| benefits | text[] | Описанные преимущества |

#### Страница для пассажиров
| Поле | Тип | Описание |
|------|-----|----------|
| base_fare | float | Базовый тариф |
| per_km_rate | float | Тариф за км |
| per_min_rate | float | Тариф за минуту |
| booking_fee | float | Сбор за заказ |
| promo_codes | object[] | Активные промокоды |
| service_types | text[] | Типы сервиса (Economy, Comfort и т.д.) |

### 1.3 Сценарий работы парсера

```
1. Парсер получает URL страницы
2. Загружает HTML-контент
   - Если страница использует JS-рендеринг → использовать headless browser
   - Если статический HTML → использовать HTTP-запрос
3. Извлекает данные по CSS-селекторам / XPath
4. Валидирует извлечённые данные:
   - Числовые поля → проверка на число
   - Обязательные поля → проверка на наличие
5. Сохраняет в базу данных с timestamp
6. Если извлечение не удалось:
   - Логирует ошибку с URL и причиной
   - Помечает запись как "требует ручной проверки"
```

### 1.4 Обработка ошибок

| Ситуация | Действие |
|----------|----------|
| Сайт недоступен (5xx) | Повторить через 1 час, макс 3 попытки |
| Страница не найдена (404) | Логировать, пометить источник как "проверить URL" |
| Структура изменилась | Логировать, создать алерт для ручной проверки |
| CAPTCHA / блокировка | Логировать, пометить как "требует прокси/ручной сбор" |

---

## 2. Модуль: Парсинг магазинов приложений

### 2.1 Целевые приложения

| Конкурент | App Store ID | Google Play ID |
|-----------|--------------|----------------|
| InDriver | id1018263498 | sinet.startup.inDriver |
| Didi | id1447432993 | com.xiaojukeji.didi.global.customer |
| Uber | id368677368 | com.ubercab |
| Cabify | id476087442 | com.cabify.rider |

### 2.2 Извлекаемые данные

| Поле | Тип | Источник |
|------|-----|----------|
| app_version | string | Текущая версия |
| release_date | date | Дата последнего обновления |
| release_notes | text | Описание изменений |
| rating | float | Средний рейтинг |
| rating_count | int | Количество оценок |
| reviews | object[] | Последние отзывы (50 шт) |

### 2.3 Структура отзыва

```json
{
  "id": "string",
  "author": "string",
  "rating": 1-5,
  "date": "ISO8601",
  "text": "string",
  "platform": "ios|android",
  "version": "string",
  "language": "es|en"
}
```

### 2.4 Сценарий сбора отзывов

```
1. Запросить последние 50 отзывов через API/парсинг
2. Для каждого отзыва:
   a. Проверить, есть ли уже в базе (по id)
   b. Если новый → сохранить
   c. Если существует → пропустить
3. Классифицировать роль автора:
   - Ключевые слова "conductor", "driver", "manejo" → водитель
   - Остальные → пассажир
4. Определить тональность:
   - rating >= 4 → положительный
   - rating == 3 → нейтральный
   - rating <= 2 → негативный
```

### 2.5 Сценарий отслеживания релизов

```
1. Запросить информацию о приложении
2. Сравнить версию с последней сохранённой
3. Если версия изменилась:
   a. Сохранить новую запись релиза
   b. Извлечь release_notes
   c. Классифицировать изменения по категориям
```

---

## 3. Модуль: Классификация данных

### 3.1 Категории изменений

| Категория | Ключевые слова (ES) | Ключевые слова (EN) |
|-----------|---------------------|---------------------|
| Тарифы | tarifa, precio, comisión, costo | fare, price, commission, cost |
| UX/UI | diseño, interfaz, pantalla, botón | design, interface, screen, button |
| Безопасность | seguridad, verificación, SOS | safety, verification, SOS |
| Водительский опыт | conductor, ganancias, viajes | driver, earnings, trips |
| Пассажирский опыт | pasajero, viaje, espera | rider, trip, wait |
| Промо | descuento, promoción, código, gratis | discount, promo, code, free |

### 3.2 Алгоритм классификации

```
1. Получить текст (release_notes или отзыв)
2. Нормализовать: lowercase, убрать спецсимволы
3. Для каждой категории:
   a. Подсчитать совпадения с ключевыми словами
   b. Если совпадений > 0 → добавить категорию
4. Если ни одна категория не подошла → "Другое"
5. Сохранить массив категорий
```

### 3.3 Классификация отзывов по роли

```
Водитель, если текст содержит:
- "conductor", "conduzco", "manejo"
- "ganancias", "comisión"
- "pasajeros" (в контексте "mis pasajeros")
- "carro", "vehículo" (в контексте владения)

Пассажир — все остальные
```

---

## 4. Модуль: Хранение данных

### 4.1 Схема базы данных

#### Таблица: competitors
```sql
id: UUID PRIMARY KEY
name: VARCHAR(100) NOT NULL
country: VARCHAR(2) DEFAULT 'PE'
website_driver: VARCHAR(500)
website_rider: VARCHAR(500)
appstore_id: VARCHAR(100)
playstore_id: VARCHAR(100)
created_at: TIMESTAMP DEFAULT NOW()
```

#### Таблица: tariffs
```sql
id: UUID PRIMARY KEY
competitor_id: UUID REFERENCES competitors(id)
type: ENUM('driver', 'rider')
commission_rate: DECIMAL(5,2)
base_fare: DECIMAL(10,2)
per_km_rate: DECIMAL(10,2)
per_min_rate: DECIMAL(10,2)
currency: VARCHAR(3) DEFAULT 'PEN'
source_url: VARCHAR(500)
collected_at: TIMESTAMP DEFAULT NOW()
```

#### Таблица: promos
```sql
id: UUID PRIMARY KEY
competitor_id: UUID REFERENCES competitors(id)
title: VARCHAR(200)
description: TEXT
code: VARCHAR(50)
discount_type: ENUM('percent', 'fixed', 'free_ride')
discount_value: DECIMAL(10,2)
valid_from: DATE
valid_until: DATE
conditions: TEXT
source_url: VARCHAR(500)
collected_at: TIMESTAMP DEFAULT NOW()
```

#### Таблица: releases
```sql
id: UUID PRIMARY KEY
competitor_id: UUID REFERENCES competitors(id)
platform: ENUM('ios', 'android')
version: VARCHAR(20)
release_date: DATE
release_notes: TEXT
categories: VARCHAR(50)[]
collected_at: TIMESTAMP DEFAULT NOW()
```

#### Таблица: reviews
```sql
id: UUID PRIMARY KEY
external_id: VARCHAR(100) UNIQUE
competitor_id: UUID REFERENCES competitors(id)
platform: ENUM('ios', 'android')
author: VARCHAR(200)
rating: SMALLINT CHECK (rating >= 1 AND rating <= 5)
text: TEXT
review_date: DATE
app_version: VARCHAR(20)
language: VARCHAR(5)
role: ENUM('driver', 'rider', 'unknown')
sentiment: ENUM('positive', 'neutral', 'negative')
categories: VARCHAR(50)[]
collected_at: TIMESTAMP DEFAULT NOW()
```

#### Таблица: collection_logs
```sql
id: UUID PRIMARY KEY
source_type: ENUM('website', 'appstore', 'playstore')
competitor_id: UUID REFERENCES competitors(id)
url: VARCHAR(500)
status: ENUM('success', 'partial', 'failed')
error_message: TEXT
items_collected: INT DEFAULT 0
started_at: TIMESTAMP
completed_at: TIMESTAMP
```

---

## 5. Модуль: Формирование отчётов

### 5.1 Сравнительная таблица тарифов

#### Входные данные
- Последние записи из таблицы `tariffs` для каждого конкурента

#### Выходной формат
```markdown
| Конкурент | Комиссия водителя | Базовый тариф | За км | За мин |
|-----------|-------------------|---------------|-------|--------|
| InDriver  | 10%               | S/3.50        | S/1.20| S/0.30 |
| Didi      | 15%               | S/4.00        | S/1.50| S/0.35 |
| ...       | ...               | ...           | ...   | ...    |
```

### 5.2 Матрица фич

#### Входные данные
- Данные releases + ручной ввод

#### Выходной формат
```markdown
| Фича | InDriver | Didi | Uber | Cabify |
|------|----------|------|------|--------|
| Торг цены | ✅ | ❌ | ❌ | ❌ |
| Подписка | ❌ | ✅ | ✅ | ❌ |
| ...  | ... | ... | ... | ... |
```

### 5.3 Дайджест изменений

#### Структура
```markdown
# Дайджест за [дата]

## Новые релизы
- InDriver v5.12.3 (iOS): [описание изменений]
- Didi v7.8.1 (Android): [описание изменений]

## Изменения тарифов
- Uber: комиссия изменилась с 25% на 23%

## Актуальные промо
- InDriver: скидка 30% на первые 3 поездки
- Cabify: бесплатная поездка до S/15

## Тренды в отзывах
- InDriver: рост негатива по теме "время ожидания"
- Uber: позитив по теме "безопасность"
```

---

## 6. Пользовательские сценарии

### UC-001: Запуск сбора данных

**Актор:** Аналитик

**Предусловия:** Система настроена, конкуренты добавлены в БД

**Основной сценарий:**
```
1. Аналитик открывает интерфейс управления
2. Выбирает конкурентов для сбора (все или конкретные)
3. Выбирает источники (сайты, appstore, playstore)
4. Нажимает "Запустить сбор"
5. Система последовательно обрабатывает каждый источник
6. По завершении отображает статистику:
   - Успешно собрано: N записей
   - Ошибки: M источников
   - Время выполнения: X минут
```

**Альтернативный сценарий — ошибка сбора:**
```
5a. Один из источников недоступен
5b. Система логирует ошибку и продолжает со следующим
5c. В финальном отчёте источник помечен как "failed"
```

---

### UC-002: Просмотр сравнительных данных

**Актор:** Продуктовый менеджер

**Предусловия:** Данные собраны

**Основной сценарий:**
```
1. Пользователь открывает раздел "Сравнение тарифов"
2. Видит таблицу с последними данными по всем конкурентам
3. Может отфильтровать по:
   - Типу (водитель/пассажир)
   - Конкуренту
   - Дате сбора
4. Может экспортировать в CSV/Excel
```

---

### UC-003: Просмотр релизов

**Актор:** Продуктовый менеджер

**Предусловия:** Данные собраны

**Основной сценарий:**
```
1. Пользователь открывает раздел "Релизы"
2. Видит список релизов, отсортированный по дате (новые сверху)
3. Для каждого релиза отображается:
   - Конкурент
   - Платформа (iOS/Android)
   - Версия
   - Дата
   - Release notes
   - Категории изменений (теги)
4. Может отфильтровать по:
   - Конкуренту
   - Платформе
   - Категории
   - Периоду
```

---

### UC-004: Анализ отзывов

**Актор:** Аналитик

**Предусловия:** Отзывы собраны и классифицированы

**Основной сценарий:**
```
1. Пользователь открывает раздел "Отзывы"
2. Видит статистику по каждому конкуренту:
   - Средний рейтинг
   - Распределение по оценкам (1-5)
   - Распределение по ролям (водитель/пассажир)
   - Распределение по тональности
3. Может перейти к списку отзывов с фильтрами:
   - Конкурент
   - Роль
   - Тональность
   - Категория
   - Период
4. Для каждого отзыва видит:
   - Текст
   - Рейтинг
   - Дату
   - Роль автора
   - Категории (теги)
```

---

### UC-005: Генерация дайджеста

**Актор:** Аналитик

**Предусловия:** Данные собраны за период

**Основной сценарий:**
```
1. Пользователь открывает раздел "Дайджест"
2. Выбирает период (неделя по умолчанию)
3. Нажимает "Сгенерировать"
4. Система формирует отчёт:
   a. Собирает релизы за период
   b. Сравнивает тарифы с предыдущим периодом
   c. Собирает активные промо
   d. Анализирует тренды в отзывах
5. Отображает preview дайджеста
6. Пользователь может:
   - Отредактировать текст
   - Добавить свои комментарии/гипотезы
   - Экспортировать в Markdown/PDF
```

---

### UC-006: Добавление гипотезы

**Актор:** Аналитик

**Предусловия:** Проведён анализ данных

**Основной сценарий:**
```
1. Пользователь находится в любом разделе с данными
2. Видит интересный инсайт
3. Нажимает "Добавить гипотезу"
4. Заполняет форму:
   - Заголовок гипотезы
   - Описание
   - Связанные данные (ссылки на релизы/отзывы/тарифы)
   - Рекомендуемое действие
5. Сохраняет
6. Гипотеза добавляется в раздел "Гипотезы" и в следующий дайджест
```

---

## 7. Требования к интерфейсу

### 7.1 Навигация

```
├── Dashboard (обзор)
├── Сбор данных
│   ├── Запустить сбор
│   └── История сборов
├── Данные
│   ├── Тарифы
│   ├── Промо
│   ├── Релизы
│   └── Отзывы
├── Анализ
│   ├── Сравнительные таблицы
│   └── Тренды
├── Дайджест
│   ├── Генерация
│   └── История
└── Гипотезы
```

### 7.2 Dashboard

Отображает:
- Дата последнего сбора данных
- Количество новых релизов за неделю
- Количество новых отзывов за неделю
- Активные промо (счётчик по конкурентам)
- Последние 5 гипотез

### 7.3 Таблицы данных

Общие требования:
- Сортировка по любому столбцу
- Фильтрация по полям
- Пагинация (20 записей на странице)
- Экспорт в CSV

---

## 8. Нефункциональные требования

### 8.1 Производительность
- Сбор данных с одного сайта: < 30 секунд
- Сбор всех данных (4 конкурента, все источники): < 10 минут
- Загрузка страницы интерфейса: < 2 секунд
- Генерация дайджеста: < 30 секунд

### 8.2 Надёжность
- Ошибка одного источника не должна блокировать остальные
- Все ошибки логируются с контекстом
- Данные не теряются при сбое (транзакции)

### 8.3 Хранение
- История тарифов: хранить все версии
- Отзывы: дедупликация по external_id
- Логи сбора: хранить 90 дней

---

## 9. Ограничения MVP

- Запуск сбора только вручную (нет расписания)
- Нет автоматических алертов
- Нет API для внешних систем
- Один регион (Перу)
- Один язык интерфейса (русский)
